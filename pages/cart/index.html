<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="../../images/Reweave logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Cart • Reweave</title>
  <link rel="stylesheet" href="/shared/styles.css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --primary-black: #000000;
      --primary-white: #ffffff;
      --luxury-gray: #f8f8f8;
      --text-gray: #666666;
      --border-gray: #e5e5e5;
      --hover-gray: #f0f0f0;
      --success: #2e7d32;
    }
    body { font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--primary-black); background: var(--primary-white); }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .page-title { font-family: 'Playfair Display', serif; font-size: 2.5rem; font-weight: 300; margin: 16px 0 8px; letter-spacing: 1px; }
    .subtext { color: var(--text-gray); font-size: 14px; font-weight: 300; }

    .cart-grid { display: grid; grid-template-columns: 1fr 360px; gap: 32px; margin-top: 24px; }
    @media (max-width: 980px) { .cart-grid { grid-template-columns: 1fr; } }

    /* Items list */
    .items-card { background: var(--primary-white); border: 1px solid var(--border-gray); border-radius: 12px; }
    .item-row { display: grid; grid-template-columns: 96px 1fr auto; gap: 16px; padding: 16px; align-items: center; border-bottom: 1px solid var(--border-gray); transition: background-color 0.3s ease; }
    .item-row:hover { background-color: var(--luxury-gray); }
    .item-row:last-child { border-bottom: none; }
    .thumb { width: 96px; height: 96px; border-radius: 10px; background: var(--luxury-gray); display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; }
    .item-main h3 { font-family: 'Montserrat', sans-serif; font-size: 16px; margin: 0 0 6px; font-weight: 400; }
    .item-meta { color: var(--text-gray); font-size: 13px; font-weight: 300; }
    .qty { display:flex; border:1px solid var(--border-gray); border-radius: 8px; overflow:hidden; }
    .qty button { width: 36px; height: 36px; border: none; background: var(--luxury-gray); cursor:pointer; font-family: 'Montserrat', sans-serif; font-weight: 300; }
    .qty input { width: 46px; text-align:center; border:none; font-family: 'Montserrat', sans-serif; font-weight: 300; }
    .item-actions { display:flex; gap:12px; align-items:center; }
    .link-muted { color: var(--text-gray); font-size: 13px; text-decoration: underline; cursor:pointer; font-family: 'Montserrat', sans-serif; font-weight: 300; }

    /* Empty cart */
    .empty-cart {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-gray);
    }
    .empty-cart i {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .empty-cart h3 {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      margin-bottom: 8px;
      color: var(--primary-black);
    }

    /* Summary */
    .summary { position: sticky; top: 24px; background: var(--luxury-gray); border: 1px solid var(--border-gray); border-radius: 12px; padding: 24px; height: fit-content; }
    .summary h3 { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 300; margin: 0 0 12px; letter-spacing: 1px; }
    .summary-row { display:flex; justify-content: space-between; align-items:center; padding: 8px 0; font-family: 'Montserrat', sans-serif; font-weight: 300; }
    .summary-row.total { border-top:1px solid var(--border-gray); margin-top:8px; padding-top:12px; font-weight:400; }
    .field { display:flex; gap:8px; margin: 8px 0 4px; }
    .field input { flex:1; padding:8px; border:1px solid var(--border-gray); border-radius:8px; font-family: 'Montserrat', sans-serif; font-weight: 300; }
    .notice { color: var(--text-gray); font-size: 13px; font-family: 'Montserrat', sans-serif; font-weight: 300; }
    .savings { color: var(--success); font-size: 12px; font-family: 'Montserrat', sans-serif; font-weight: 300; }
    
    /* Buttons */
    .btn {
      display: inline-block;
      padding: 14px 24px;
      background: var(--primary-black);
      color: var(--primary-white);
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      width: 100%;
      text-decoration: none;
      font-family: 'Montserrat', sans-serif;
    }
    
    .btn:hover {
      background: var(--primary-white);
      color: var(--primary-black);
      border: 1px solid var(--primary-black);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: var(--primary-white);
      color: var(--primary-black);
      border: 1px solid var(--border-gray);
    }
    
    .btn-secondary:hover {
      background: var(--primary-black);
      color: var(--primary-white);
    }

    /* Continue shopping */
    .continue-shopping {
      display: inline-block;
      margin-top: 16px;
      color: var(--text-gray);
      text-decoration: none;
      font-size: 14px;
    }
    
    .continue-shopping:hover {
      color: var(--primary-black);
    }

    /* Checkout Form Styles */
    .checkout-form-container {
      width: 100%;
      max-width: 1100px;
      margin: 40px auto 0;
      padding: 0 24px;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .form-card {
      background: var(--primary-white);
      border: 1px solid var(--border-gray);
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-gray);
    }
    
    .form-header h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 300;
      margin: 0;
      letter-spacing: 1px;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-gray);
      cursor: pointer;
      padding: 4px 8px;
      transition: color 0.3s ease;
    }
    
    .close-btn:hover {
      color: var(--primary-black);
    }
    
    .form-section {
      margin-bottom: 32px;
    }
    
    .form-section h3 {
      font-family: 'Playfair Display', serif;
      font-size: 1.2rem;
      font-weight: 300;
      margin: 0 0 20px;
      letter-spacing: 1px;
      color: var(--primary-black);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--primary-black);
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-gray);
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
      font-weight: 300;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-black);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-actions {
      display: flex;
      gap: 16px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border-gray);
    }
    
    .form-actions .btn {
      flex: 1;
    }

    /* Upselling Section */
    .upselling-section {
      margin-top: 60px;
      padding: 40px 0;
      background: #fafafa;
    }
    
    .section-title {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--primary-black);
      margin-bottom: 30px;
      text-align: center;
    }
    
    .recommended-products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 24px;
      margin-top: 30px;
    }
    
    .recommended-product-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    
    .recommended-product-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    
    .recommended-product-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #f5f5f5;
      cursor: pointer;
    }
    
    .recommended-product-info {
      padding: 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .recommended-product-name {
      font-size: 1rem;
      font-weight: 500;
      color: var(--primary-black);
      margin-bottom: 8px;
      cursor: pointer;
    }
    
    .recommended-product-price {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary-black);
      margin-bottom: 12px;
    }
    
    .recommended-product-actions {
      margin-top: auto;
    }
    
    .recommended-product-actions .btn {
      width: 100%;
      padding: 10px 16px;
      font-size: 0.9rem;
      border-radius: 6px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 16px; }
      .summary { padding: 20px; }
      .form-card { padding: 20px; }
      .form-actions {
        flex-direction: column;
      }
      .recommended-products {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 16px;
      }
      .upselling-section {
        margin-top: 40px;
        padding: 30px 0;
      }
    }
    
    /* Header Styles */
    .luxury-header {
      position: fixed; top: 0; left: 0; right: 0;
      background: var(--primary-white); border-bottom: 1px solid var(--border-gray);
      z-index: 1000; backdrop-filter: blur(10px);
    }
    
    .header-container {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px 30px; max-width: 1200px; margin: 0 auto;
    }
    
    .header-left, .header-right {
      display: flex; align-items: center; gap: 25px;
    }
    
    .logo-center a {
      font-family: 'Playfair Display', serif;
      font-size: 28px; font-weight: 300;
      letter-spacing: 2px; text-decoration: none;
      color: var(--primary-black);
    }
    
    .menu-btn, .utility-btn {
      background: none; border: none; cursor: pointer;
      font-family: 'Montserrat', sans-serif; font-weight: 300; font-size: 13px;
      display: flex; align-items: center; gap: 6px;
      transition: opacity 0.3s ease; color: var(--primary-black);
    }
    
    .menu-btn:hover, .utility-btn:hover { opacity: 0.7; }
    
    .cart-btn {
      position: relative; padding: 8px 16px;
      border: 1px solid var(--border-gray); border-radius: 20px;
      background: var(--primary-white);
    }
    
    .cart-count {
      position: absolute; top: -5px; right: -5px;
      background: var(--primary-black); color: var(--primary-white);
      border-radius: 50%; width: 18px; height: 18px;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 500;
    }

    /* Hidden Navigation */
    .hidden-nav {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: var(--primary-white); z-index: 2000;
      transform: translateX(-100%); transition: transform 0.3s ease;
      overflow-y: auto;
    }
    
    .hidden-nav.active { transform: translateX(0); }
    
    .nav-content {
      padding: 20px 30px;
    }
    
    .close-nav {
      display: flex; align-items: center; gap: 8px;
      background: none; border: none; cursor: pointer;
      font-family: 'Montserrat', sans-serif; font-weight: 300; font-size: 14px;
      margin-bottom: 20px; color: var(--primary-black);
    }
    
    .nav-section {
      margin-bottom: 24px;
    }
    
    .nav-section h3 {
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
      font-weight: 500;
      margin: 0 0 12px 0;
      color: var(--primary-black);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .nav-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .nav-section li {
      margin-bottom: 8px;
    }
    
    .nav-section a {
      color: var(--text-gray);
      text-decoration: none;
      font-family: 'Montserrat', sans-serif;
      font-size: 16px;
      font-weight: 300;
      transition: color 0.3s ease;
    }
    
    .nav-section a:hover {
      color: var(--primary-black);
    }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 100px;
      right: 20px;
      background: var(--primary-black);
      color: var(--primary-white);
      padding: 16px 24px;
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
      font-weight: 300;
      z-index: 10000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      background: #2e7d32;
    }
    
    .toast.error {
      background: #d32f2f;
    }
  </style>
</head>
<body>
  <!-- Standardized Header Component for Reweave -->
  <header class="header">
    <div class="header-container">
      <div class="nav-left">
        <button class="nav-btn" title="AI Try-On" onclick="window.location.href='/pages/tryon/index.html'">AI Try-On</button>
      </div>
      
      <a href="/" class="logo">REWEAVE</a>
      
      <div class="nav-right">
        <button class="nav-btn cart-btn">
          <i class="fas fa-shopping-bag"></i>
          <span class="cart-count" id="cartCount">0</span>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="page-title">Your Cart</h1>
    <p class="subtext">Review your items and proceed to checkout</p>

    <div class="cart-grid">
      <!-- Items list -->
      <div class="items-card" id="cartItems">
        <!-- Cart items will be populated here -->
      </div>

      <!-- Summary -->
      <div class="summary">
        <h3>Order Summary</h3>
        <div id="summaryContent">
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="subtotal">RM 0.00</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span id="shipping">RM 10.00</span>
          </div>
          <div class="summary-row">
            <span>Tax (6%)</span>
            <span id="tax">RM 0.00</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span id="total">RM 0.00</span>
          </div>
        </div>

        <!-- Promo code -->
        <div style="margin: 16px 0;">
          <div class="field">
            <input type="text" id="promoCode" placeholder="Promo code" />
            <button class="btn btn-secondary" onclick="applyPromo()" style="width: auto;">Apply</button>
          </div>
          <div class="notice" id="promoNotice"></div>
        </div>

        <!-- Checkout buttons -->
        <button class="btn" id="checkoutBtn" onclick="showCheckout()">Proceed to Checkout</button>
        <a href="../shop/index.html" class="continue-shopping"><i class="fas fa-arrow-left"></i> Continue Shopping</a>

        <!-- Guest checkout info -->
        <div style="margin-top: 16px; padding: 12px; background: var(--primary-white); border: 1px solid var(--border-gray); border-radius: 8px;">
          <p style="font-size: 12px; color: var(--text-gray); margin: 0;">
            <i class="fas fa-info-circle"></i> No account needed! Complete your purchase as a guest.
          </p>
        </div>
      </div>
    </div>

    <!-- Checkout Form (initially hidden, appears when clicking Proceed to Checkout) -->
    <div class="checkout-form-container" id="checkoutFormContainer" style="display: none;">
      <div class="form-card">
        <div class="form-header">
          <h2>Delivery Information</h2>
          <button class="close-btn" onclick="closeCheckout()" aria-label="Close checkout form">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <form id="checkoutForm" onsubmit="handleCheckout(event)">
          <!-- Contact Information -->
          <div class="form-section">
            <h3>Contact Details</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="fullName">Full Name *</label>
                <input type="text" id="fullName" name="fullName" required placeholder="John Doe" />
              </div>
              <div class="form-group">
                <label for="email">Email Address *</label>
                <input type="email" id="email" name="email" required placeholder="john@example.com" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="phone">Phone Number *</label>
                <input type="tel" id="phone" name="phone" required placeholder="+60 12-345-6789" />
              </div>
            </div>
          </div>

          <!-- Shipping Address -->
          <div class="form-section">
            <h3>Shipping Address</h3>
            <div class="form-group">
              <label for="address">Street Address *</label>
              <input type="text" id="address" name="address" required placeholder="123 Main Street" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" name="city" required placeholder="Kuala Lumpur" />
              </div>
              <div class="form-group">
                <label for="state">State *</label>
                <input type="text" id="state" name="state" required placeholder="Selangor" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="postcode">Postal Code *</label>
                <input type="text" id="postcode" name="postcode" required placeholder="50000" pattern="[0-9]{5}" />
              </div>
              <div class="form-group">
                <label for="country">Country *</label>
                <select id="country" name="country" required>
                  <option value="MY" selected>Malaysia</option>
                  <option value="SG">Singapore</option>
                  <option value="ID">Indonesia</option>
                  <option value="TH">Thailand</option>
                  <option value="PH">Philippines</option>
                  <option value="VN">Vietnam</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Delivery Instructions (Optional) -->
          <div class="form-section">
            <h3>Delivery Instructions (Optional)</h3>
            <div class="form-group">
              <label for="instructions">Special Instructions</label>
              <textarea id="instructions" name="instructions" rows="3" placeholder="Leave at door, call before delivery, etc."></textarea>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeCheckout()">Back to Cart</button>
            <button type="submit" class="btn" id="submitCheckoutBtn">Complete Order</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Upselling / Recommended Products Section -->
    <div class="upselling-section" id="upsellingSection" style="display: none;">
      <div class="container">
        <h2 class="section-title">You May Also Like</h2>
        <div class="recommended-products" id="recommendedProducts">
          <!-- Recommended products will be loaded here -->
        </div>
      </div>
    </div>
  </main>

  <script>
    // Cart functionality
    let cart = [];
    let promoDiscount = 0;
    let promoCode = '';

    // Initialize cart - use reweave-cart key from main site
    function initCart() {
      const cartData = localStorage.getItem('reweave-cart');
      console.log('Raw cart data from localStorage:', cartData);
      
      cart = JSON.parse(cartData || '[]');
      console.log('Parsed cart data:', cart);
      
      // Debug: Log each item's price
      if (cart.length > 0) {
        console.log('Cart items with prices:');
        cart.forEach((item, i) => {
          console.log(`  Item ${i}:`, {
            name: item.name,
            id: item.id,
            price: item.price,
            priceType: typeof item.price,
            allKeys: Object.keys(item),
            fullItem: item
          });
        });
      }
      
      // If cart is empty, show a message and hide checkout
      if (cart.length === 0) {
        console.log('Cart is empty');
      } else {
        console.log(`Cart has ${cart.length} items`);
      }
      
      renderCart();
      updateSummary();
    }

    // Render cart items
    function renderCart() {
      const cartItems = document.getElementById('cartItems');
      console.log('Rendering cart with items:', cart);
      
      if (cart.length === 0) {
        cartItems.innerHTML = `
          <div class="empty-cart">
            <i class="fas fa-shopping-bag"></i>
            <h3>Your cart is empty</h3>
            <p>Add some beautiful items to get started</p>
            <a href="../shop/index.html" class="btn" style="margin-top: 16px;">Continue Shopping</a>
          </div>
        `;
        document.getElementById('checkoutBtn').style.display = 'none';
        return;
      }
      
      // Show checkout button when cart has items
      document.getElementById('checkoutBtn').style.display = 'block';

      cartItems.innerHTML = cart.map((item, index) => {
        // Clean price data - remove RM prefix and convert to number
        let price = item.price || 0;
        console.log(`Cart item ${index}:`, {
          name: item.name,
          rawPrice: item.price,
          priceType: typeof item.price,
          allFields: Object.keys(item)
        });
        
        if (typeof price === 'string') {
          price = price.replace(/RM\s*/g, ''); // Remove RM prefix
          price = parseFloat(price) || 0;
        } else {
          price = parseFloat(price) || 0;
        }
        
        if (price === 0 || isNaN(price)) {
          console.error(`Item ${index} (${item.name}) has invalid price:`, item);
        }
        
        // Support both 'qty' and 'quantity' field names
        const qty = parseInt(item.qty || item.quantity || 1);
        const itemTotal = price * qty;
        
        return `
          <div class="item-row">
            <div class="thumb">
              <img src="${item.image || '../../images/Batik Front (WIP).png'}" alt="${item.name}" />
            </div>
            <div class="item-main">
              <h3>${item.name}</h3>
              <div class="item-meta">${item.variant || ''}</div>
              <div class="item-meta">RM ${price.toFixed(2)}</div>
            </div>
            <div class="item-actions">
              <div class="qty">
                <button onclick="updateQuantity(${index}, -1)">−</button>
                <input type="number" value="${qty}" min="1" onchange="setQuantity(${index}, this.value)">
                <button onclick="updateQuantity(${index}, 1)">+</button>
              </div>
              <div style="text-align: right; min-width: 80px;">
                <div style="font-weight: 500;">RM ${itemTotal.toFixed(2)}</div>
                <div class="link-muted" onclick="removeItem(${index})">Remove</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Update quantity
    function updateQuantity(index, change) {
      // Support both 'qty' and 'quantity' field names
      const currentQty = parseInt(cart[index].qty || cart[index].quantity || 1);
      const newQty = Math.max(1, currentQty + change);
      // Update both fields for compatibility
      cart[index].qty = newQty;
      cart[index].quantity = newQty;
      saveCart();
      renderCart();
      updateSummary();
    }

    // Set quantity directly
    function setQuantity(index, qty) {
      const newQty = Math.max(1, parseInt(qty) || 1);
      // Update both fields for compatibility
      cart[index].qty = newQty;
      cart[index].quantity = newQty;
      saveCart();
      renderCart();
      updateSummary();
    }

    // Remove item
    function removeItem(index) {
      cart.splice(index, 1);
      saveCart();
      renderCart();
      updateSummary();
      updateCartCount();
    }

    // Save cart to localStorage
    function saveCart() {
      localStorage.setItem('reweave-cart', JSON.stringify(cart));
    }

    // Update summary
    function updateSummary() {
      console.log('Updating summary with cart:', cart);
      
      const subtotal = cart.reduce((sum, item) => {
        // Support both 'qty' and 'quantity' field names
        const qty = item.qty || item.quantity || 1;
        
        // Get price - handle multiple formats
        let price = item.price;
        if (price === null || price === undefined) {
          console.warn(`Item ${item.name} has no price field. Available fields:`, Object.keys(item));
          price = 0;
        } else if (typeof price === 'string') {
          price = parseFloat(price.replace(/RM\s*/g, '')) || 0;
        } else {
          price = parseFloat(price) || 0;
        }
        
        const itemTotal = price * qty;
        console.log(`Item: ${item.name}, Raw Price: ${item.price}, Parsed Price: ${price}, Qty: ${qty}, Total: ${itemTotal}`);
        return sum + itemTotal;
      }, 0);
      
      const shipping = 10; // Fixed shipping
      const tax = subtotal * 0.06; // 6% tax
      const discount = promoDiscount > 0 ? subtotal * promoDiscount : 0;
      const total = subtotal + shipping + tax - discount;

      console.log(`Subtotal: ${subtotal}, Shipping: ${shipping}, Tax: ${tax}, Discount: ${discount}, Total: ${total}`);

      document.getElementById('subtotal').textContent = `RM ${subtotal.toFixed(2)}`;
      document.getElementById('shipping').textContent = `RM ${shipping.toFixed(2)}`;
      document.getElementById('tax').textContent = `RM ${tax.toFixed(2)}`;
      document.getElementById('total').textContent = `RM ${total.toFixed(2)}`;

      // Show promo savings if applied
      const promoNotice = document.getElementById('promoNotice');
      if (promoDiscount > 0) {
        promoNotice.innerHTML = `<span class="savings">✓ Promo code applied: ${(promoDiscount * 100).toFixed(0)}% off</span>`;
      }
    }

    // Apply promo code
    function applyPromo() {
      const code = document.getElementById('promoCode').value.trim().toUpperCase();
      const promoNotice = document.getElementById('promoNotice');
      
      // Simple promo codes
      const promos = {
        'WELCOME10': 0.10,
        'FIRST5': 0.05,
        'REWEAVE15': 0.15
      };

      if (promos[code]) {
        promoDiscount = promos[code];
        promoCode = code;
        promoNotice.innerHTML = `<span class="savings">✓ Promo code applied: ${(promoDiscount * 100).toFixed(0)}% off</span>`;
        updateSummary();
      } else if (code) {
        promoNotice.innerHTML = '❌ Invalid promo code';
      }
    }

    // Update cart count in header
    function updateCartCount() {
      // Support both 'qty' and 'quantity' field names
      const count = cart.reduce((sum, item) => sum + (item.qty || item.quantity || 1), 0);
      const badge = document.querySelector('.cart-count');
      if (badge) badge.textContent = String(count);
    }

    // Load recommended products for upselling
    async function loadRecommendedProducts() {
      const upsellingSection = document.getElementById('upsellingSection');
      const recommendedProducts = document.getElementById('recommendedProducts');
      
      if (!upsellingSection || !recommendedProducts) return;
      
      try {
        // Get current cart product IDs to exclude them
        const cartProductIds = cart.map(item => item.productId || item.id).filter(Boolean);
        
        // Load Supabase client from shared script
        const supabaseUrl = 'https://dkpaeiyixdwzjpvvszyy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrcGFlaXlpeGR3empwdnZzenl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MjAyNTUsImV4cCI6MjA3OTA5NjI1NX0.tcESQl8N7gFFkzh-OOvRBnHFyJ2CC9W0-vs3e6ItZTc';
        
        if (typeof supabase === 'undefined') {
          console.warn('Supabase not available for recommended products');
          return;
        }
        
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Fetch products (excluding items already in cart)
        const { data, error } = await supabaseClient
          .from('product_variants')
          .select('id, product_id, variant_name, price, color, image, is_active, products(title, description, category)')
          .eq('is_active', true)
          .limit(4);
        
        if (error) {
          console.error('Error loading recommended products:', error);
          return;
        }
        
        if (!data || data.length === 0) {
          return;
        }
        
        // Filter out products already in cart and get unique products
        const uniqueProducts = [];
        const seenProductIds = new Set();
        
        for (const variant of data) {
          const productId = variant.product_id || variant.id;
          if (!cartProductIds.includes(productId) && !seenProductIds.has(productId)) {
            seenProductIds.add(productId);
            uniqueProducts.push(variant);
            if (uniqueProducts.length >= 4) break;
          }
        }
        
        if (uniqueProducts.length === 0) {
          return;
        }
        
        // Render recommended products
        recommendedProducts.innerHTML = uniqueProducts.map(variant => {
          const product = variant.products || {};
          const price = variant.price ? (typeof variant.price === 'string' ? parseFloat(variant.price.replace(/RM\s*/gi, '')) : variant.price) : 0;
          const priceDisplay = price > 0 ? (typeof variant.price === 'string' ? variant.price : `RM ${variant.price.toFixed(2)}`) : 'RM 0.00';
          const image = variant.image || 'images/placeholder.png';
          const name = product.title || variant.variant_name || 'Product';
          const productId = variant.product_id || variant.id;
          const variantId = variant.id;
          const variantName = variant.variant_name || variant.color || 'Default';
          
          return `
            <div class="recommended-product-card">
              <img src="${image}" alt="${name}" class="recommended-product-image" 
                   onclick="window.location.href='/pages/shop/index.html'" 
                   onerror="this.src='images/placeholder.png'">
              <div class="recommended-product-info">
                <div class="recommended-product-name" onclick="window.location.href='/pages/shop/index.html'">${name}</div>
                <div class="recommended-product-price">${priceDisplay}</div>
                <div class="recommended-product-actions">
                  <button class="btn" 
                          data-add-to-cart 
                          data-product-id="${productId}"
                          data-product-name="${name}"
                          data-product-price="${price}"
                          data-product-image="${image}"
                          data-variant="${variantName}"
                          onclick="event.stopPropagation();">
                    Add to Cart
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        // Show upselling section
        upsellingSection.style.display = 'block';
      } catch (err) {
        console.error('Error in loadRecommendedProducts:', err);
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
      initCart();
      
      // Update cart count on page load
      updateCartCount();
      
      // Load recommended products after a short delay
      setTimeout(loadRecommendedProducts, 500);
      
      // Listen for cart updates from addToCart function
      window.addEventListener('cartUpdated', function() {
        console.log('Cart updated event received, refreshing cart display...');
        initCart();
        updateCartCount();
        // Reload recommended products to exclude newly added items
        setTimeout(loadRecommendedProducts, 100);
      });
    });

    // Mobile menu functionality

    // Checkout Form Functions
    function showCheckout() {
      const checkoutForm = document.getElementById('checkoutFormContainer');
      if (checkoutForm) {
        checkoutForm.style.display = 'block';
        // Scroll to form
        checkoutForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Hide checkout button
        const checkoutBtn = document.getElementById('checkoutBtn');
        if (checkoutBtn) {
          checkoutBtn.style.display = 'none';
        }
      }
    }

    function closeCheckout() {
      const checkoutForm = document.getElementById('checkoutFormContainer');
      if (checkoutForm) {
        checkoutForm.style.display = 'none';
        // Show checkout button again
        const checkoutBtn = document.getElementById('checkoutBtn');
        if (checkoutBtn && cart.length > 0) {
          checkoutBtn.style.display = 'block';
        }
      }
    }

    function handleCheckout(event) {
      event.preventDefault();
      
      // Get form data
      const formData = {
        contact: {
          fullName: document.getElementById('fullName').value,
          email: document.getElementById('email').value,
          phone: document.getElementById('phone').value
        },
        shipping: {
          address: document.getElementById('address').value,
          city: document.getElementById('city').value,
          state: document.getElementById('state').value,
          postcode: document.getElementById('postcode').value,
          country: document.getElementById('country').value,
          instructions: document.getElementById('instructions').value
        },
        order: {
          items: cart,
          subtotal: calculateSubtotal(),
          shipping: parseFloat(document.getElementById('shipping').textContent.replace('RM ', '')),
          tax: parseFloat(document.getElementById('tax').textContent.replace('RM ', '')),
          total: parseFloat(document.getElementById('total').textContent.replace('RM ', '')),
          promoCode: promoCode || null,
          promoDiscount: promoDiscount
        },
        timestamp: new Date().toISOString()
      };

      // Disable submit button
      const submitBtn = document.getElementById('submitCheckoutBtn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';
      }

      // Save order data to localStorage (for now - you can send to backend later)
      localStorage.setItem('reweave-order', JSON.stringify(formData));
      
      // Log order data (for debugging)
      console.log('Order submitted:', formData);

      // Simulate processing delay
      setTimeout(() => {
        // Show success message
        const total = formData.order.total.toFixed(2);
        if (confirm('Order placed successfully!\n\nOrder Total: RM ' + total + '\n\nYou will receive a confirmation email shortly.\n\nClick OK to clear cart and return home.')) {
          // Clear cart
          cart = [];
          localStorage.removeItem('reweave-cart');
          
          // Redirect to home
          window.location.href = '/';
        } else {
          // Keep cart and reload
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Complete Order';
          }
        }
      }, 1000);

      // In production, you would send this to your backend:
      // fetch('/api/orders', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify(formData)
      // })
      // .then(response => response.json())
      // .then(data => {
      //   // Handle success
      //   window.location.href = '/order-confirmation?id=' + data.orderId;
      // })
      // .catch(error => {
      //   // Handle error
      //   alert('Error placing order. Please try again.');
      //   if (submitBtn) {
      //     submitBtn.disabled = false;
      //     submitBtn.textContent = 'Complete Order';
      //   }
      // });
    }

    function calculateSubtotal() {
      return cart.reduce((sum, item) => {
        let price = item.price || 0;
        if (typeof price === 'string') {
          price = parseFloat(price.replace(/RM\s*/g, '')) || 0;
        } else {
          price = parseFloat(price) || 0;
        }
        const qty = parseInt(item.qty || item.quantity || 1);
        return sum + (price * qty);
      }, 0);
    }
  </script>
  
  <!-- Toast Notification Container -->
  <div id="toastContainer" style="position: fixed; top: 100px; right: 20px; z-index: 10000;"></div>
  
  <!-- Toast Notification Script -->
  <script>
    // Toast notification system
    function showToast(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      
      container.appendChild(toast);
      
      // Trigger animation
      setTimeout(() => toast.classList.add('show'), 10);
      
      // Remove after duration
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }
    
    // Override alert function to use toast
    window.alert = function(message) {
      showToast(message, 'success');
    };
  </script>
  
  <!-- Standardized Footer Component for Reweave -->
  <footer class="footer">
    <div class="container">
      <div class="footer-brand">REWEAVE</div>
      <div class="footer-text">
        Sustainable fashion, reimagined. Crafting heritage into modern essentials.
      </div>
      <div class="footer-trust">
        <span class="trust-badge">FPX Available</span>
        <span class="trust-badge">Visa</span>
        <span class="trust-badge">Mastercard</span>
        <span class="trust-badge">30-day Returns</span>
      </div>
    </div>
  </footer>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Shared Scripts -->
  <script src="/shared/script.js"></script>
  
  <!-- AI Chatbot Widget -->
  <script src="/shared/chatbot.js"></script>
</body>
</html>