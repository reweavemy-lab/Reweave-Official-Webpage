<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
        <link rel="icon" type="image/png" href="../../images/Reweave_logo-removebg-preview.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Try-On - Reweave</title>
  <link rel="stylesheet" href="../../shared/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="preconnect" href="http://localhost:8501">
    <link rel="dns-prefetch" href="//api.reweave.my">
  <style>
        /* Try-On Page Specific Styles */
        .tryon-container {
            padding: 120px 0 80px;
        }
        
        .tryon-header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .tryon-header h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .tryon-header p {
            max-width: 700px;
            margin: 0 auto;
            color: var(--earth-brown);
        }
        
        .tryon-layout {
            display: flex;
            gap: 30px;
        }
        
        .tryon-preview {
            flex: 1;
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .tryon-options {
            flex: 0 0 300px;
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .upload-container {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-container:hover {
            border-color: var(--primary);
        }
        
        .upload-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .upload-text {
            margin-bottom: 20px;
        }
        
        .upload-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .upload-btn:hover {
            background-color: #2d4832;
        }
        
        .camera-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .camera-btn:hover {
            background-color: #8fa077;
        }
        
        .preview-container {
            width: 100%;
            height: 400px;
            background-color: #f5f5f5;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 18px;
            position: relative;
            overflow: hidden;
        }
        
        .product-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .option-group {
            margin-bottom: 25px;
        }
        
        .option-group h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .product-selector {
            margin-bottom: 20px;
        }
        
        .product-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .product-option:hover {
            background-color: #f5f5f5;
        }
        
        .product-option.selected {
            background-color: #e8f0e0;
        }
        
        .product-option img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 15px;
        }
        
        .product-option-info h4 {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .product-option-info p {
            font-size: 0.8rem;
            color: var(--earth-brown);
        }
        
        .size-selector, .color-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .size-option, .color-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .size-option:hover, .color-option:hover {
            border-color: var(--primary);
        }
        
        .size-option.selected, .color-option.selected {
            border-color: var(--primary);
            background-color: var(--primary);
            color: white;
        }
        
        .color-option {
            border-radius: 50%;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        
        .action-buttons .btn {
            flex: 1;
            text-align: center;
        }
        
        @media (max-width: 992px) {
            .tryon-layout {
                flex-direction: column;
            }
            
            .tryon-options {
                flex: 0 0 auto;
            }
        }
        
        /* Enhanced Try-On Styles */
        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .upload-success {
            text-align: center;
            color: white;
        }
        
        .upload-success i {
            font-size: 2rem;
            color: #28a745;
            margin-bottom: 10px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .try-on-result {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .result-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            color: white;
            padding: 20px;
        }
        
        .result-info h3 {
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .result-info p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .action-buttons {
            display: none;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-buttons.show {
            display: flex;
        }

        /* Wardrobe Mirror & Outfit Co-Pilot */
        .feature-section { margin-top: 40px; }
        .feature-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
        .feature-header h2 { font-size:1.6rem; font-family: var(--font-serif); font-weight:300; letter-spacing:1px; }
        .feature-grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; }
        .feature-card { border:1px solid #e0e0e0; border-radius:10px; padding:12px; background:#fff; display:flex; gap:12px; align-items:center; }
        .feature-thumb { width:72px; height:72px; border-radius:8px; background:#f8f8f8; overflow:hidden; }
        .feature-thumb img { width:100%; height:100%; object-fit:cover; }
        .feature-info { flex:1; }
        .feature-info .name { font-size:14px; font-weight:500; }
        .feature-info .price { font-size:13px; color:#666; }
        .feature-actions { display:flex; gap:8px; }
        .feature-actions .btn { padding:8px 10px; border-radius:8px; font-size:12px; width:auto; }
        @media (max-width: 980px){ .feature-grid { grid-template-columns:1fr; } }
        .sales-voice { font-size:13px; color:#333; margin-top:6px; }
  </style>
  <script>window.REWEAVE_API_BASE = 'http://127.0.0.1:3002';</script>
</head>
<body>
    <!-- Standardized Header Component for Reweave -->
    <div id="header-container"></div>

    <!-- Search Overlay -->
    <div class="search-overlay" aria-hidden="true">
        <div class="search-panel">
            <div class="search-header">
                <button class="search-close" aria-label="Close Search">
                    <i class="fas fa-times"></i>
                </button>
                <h3>Search</h3>
            </div>
            <div class="search-body">
                <div class="search-input-wrap">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search products, stories, categories..." aria-label="Search input" />
                </div>
                <div class="search-suggestions">
                    <p>Popular searches:</p>
                    <div class="tags">
                        <a href="../shop/index.html">Batik</a>
                        <a href="../shop/index.html">Handbags</a>
                        <a href="../shop/index.html">Artisan</a>
                        <a href="../journal/index.html">Journal</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="search-backdrop"></div>
    </div>

    <section class="tryon-container">
        <div class="container">
            <div class="tryon-header">
                <h1>Virtual Try-On</h1>
                <p>See how our products look on you before you buy.</p>
            </div>

            <div style="width:100%;max-width:1200px;margin:0 auto;">
                <div id="streamlit-container" style="position:relative;">
                    <iframe id="ai-tryon-frame" src="http://localhost:8501/" loading="lazy" style="width:100%;height:1000px;border:none;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.08);"></iframe>
                    <div id="streamlit-loading" style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;border-radius:12px;">
                        <div style="text-align:center;">
                            <div class="spinner" style="margin:0 auto 20px;"></div>
                            <p>Loading AI Try-On Experience...</p>
                        </div>
                    </div>
                </div>
                <div style="text-align:center;margin-top:16px;">
                    <a id="openStreamlitTab" href="#" class="btn" target="_blank">Open in new tab</a>
                    <button id="refresh-streamlit" class="btn btn-outline">Refresh Try-On</button>
                </div>
            </div>

            <div class="feature-section" id="wardrobe-mirror">
                <div class="feature-header">
                    <h2>Wardrobe Mirror</h2>
                    <div>
                        <input id="mirrorInput" type="file" accept="image/*" multiple style="display:none;" />
                        <button class="btn btn-outline" onclick="document.getElementById('mirrorInput').click()">Upload Wardrobe Photos</button>
                        <button class="btn" id="mirrorSuggest">Suggest Matches</button>
                    </div>
                </div>
                <div id="mirrorPreview" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;"></div>
                <div class="feature-grid" id="mirrorSuggestions"></div>
            </div>

            <div class="feature-section" id="outfit-copilot">
                <div class="feature-header">
                    <h2>Outfit Coâ€‘Pilot</h2>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px;">
                    <select id="copilotOccasion" class="select">
                        <option value="work">Work</option>
                        <option value="casual">Casual</option>
                        <option value="evening">Evening</option>
                    </select>
                    <select id="copilotPalette" class="select">
                        <option value="neutral">Neutral</option>
                        <option value="warm">Warm</option>
                        <option value="cool">Cool</option>
                    </select>
                    <input id="copilotBudget" type="number" class="select" placeholder="Budget (RM)" />
                </div>
                <div style="margin-bottom:12px;">
                    <button class="btn" id="copilotRecommend">Recommend Outfit</button>
                </div>
                <div class="feature-grid" id="copilotSuggestions"></div>
            </div>

            <div class="tryon-layout" style="display:none;">
                <div class="tryon-preview">
                    <div class="upload-container" id="upload-area">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <h3>Upload Your Photo</h3>
                            <p>Drag and drop your image here or click to browse</p>
                        </div>
                        <label for="image-upload" class="upload-btn">Choose File</label>
                        <input type="file" id="image-upload" accept="image/*" style="display: none;">
                    </div>
                    
                    <div class="camera-container">
                        <button id="camera-btn" class="camera-btn">
                            <i class="fas fa-camera"></i> Use Camera
                        </button>
                    </div>
                    
                    <div class="preview-container" id="preview-container">
                        <span>Your preview will appear here</span>
                        <div class="product-overlay" id="product-overlay"></div>
                    </div>
                    
                    <div class="action-buttons">
                        <a href="#" class="btn">Share to Community</a>
                        <a href="../shop/index.html" class="btn btn-outline">Shop This Look</a>
                    </div>
                </div>
                
                <!-- Try-On Options -->
                <div class="tryon-options">
                    <div class="option-group">
                        <h3>Select Product</h3>
                        <div class="product-selector">
                            <div class="product-option selected">
                                <img src="https://images.unsplash.com/photo-1566150905458-1bf1fc113f0d?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&q=80" alt="Artisan Tote">
                                <div class="product-option-info">
                                    <h4>Artisan Tote</h4>
                                    <p>$89.00</p>
                                </div>
                            </div>
                            <div class="product-option">
                                <img src="https://images.unsplash.com/photo-1590874103328-eac38a683ce7?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&q=80" alt="Heritage Backpack">
                                <div class="product-option-info">
                                    <h4>Heritage Backpack</h4>
                                    <p>$129.00</p>
                                </div>
                            </div>
                            <div class="product-option">
                                <img src="https://images.unsplash.com/photo-1544816155-12df9643f363?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&q=80" alt="Summer Crossbody">
                                <div class="product-option-info">
                                    <h4>Summer Crossbody</h4>
                                    <p>$79.00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="option-group">
                        <h3>Size</h3>
                        <div class="size-selector">
                            <div class="size-option">S</div>
                            <div class="size-option selected">M</div>
                            <div class="size-option">L</div>
                        </div>
                    </div>
                    
                    <div class="option-group">
                        <h3>Color</h3>
                        <div class="color-selector">
                            <div class="color-option selected" style="background-color: #e0c9a6;"></div>
                            <div class="color-option" style="background-color: #5d7599;"></div>
                            <div class="color-option" style="background-color: #6b705c;"></div>
                        </div>
                    </div>
                    
                    <div class="option-group">
                        <h3>Strap Length</h3>
                        <input type="range" min="1" max="100" value="50" class="slider" id="strap-length">
                    </div>
                    
                    <div class="option-group">
                        <h3>Position</h3>
                        <div class="position-options">
                            <button class="btn btn-outline">Left Shoulder</button>
                            <button class="btn">Right Shoulder</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Standardized Footer Component for Reweave -->
    <div id="footer-container"></div>

    <script src="../../shared/script.js"></script>
    <script>
        // Load standardized header and footer
        async function loadStandardizedComponents() {
            try {
                const [headerResponse, footerResponse] = await Promise.all([
                    fetch('../../shared/header.html'),
                    fetch('../../shared/footer.html')
                ]);
                
                const headerHtml = await headerResponse.text();
                const footerHtml = await footerResponse.text();
                
                document.getElementById('header-container').innerHTML = headerHtml;
                document.getElementById('footer-container').innerHTML = footerHtml;
                
                // Initialize header functionality
                initializeHeader();
            } catch (error) {
                console.error('Failed to load standardized components:', error);
            }
        }

        // Enhanced AI Try-On functionality with Streamlit integration
        
        // Streamlit Integration Functions
        function initializeStreamlitIntegration() {
            const iframe = document.getElementById('ai-tryon-frame');
            const loadingDiv = document.getElementById('streamlit-loading');
            const refreshBtn = document.getElementById('refresh-streamlit');
            
            // Hide loading overlay when iframe loads
            if (iframe) {
                iframe.addEventListener('load', function() {
                    if (loadingDiv) {
                        loadingDiv.style.display = 'none';
                    }
                    // Apply product preselection after iframe loads
                    setTimeout(applyProductPreselection, 1000);
                });
                
                // Handle iframe errors
                iframe.addEventListener('error', function() {
                    if (loadingDiv) {
                        loadingDiv.innerHTML = '<div style="text-align:center;color:#c00;"><p>Failed to load AI Try-On.</p><button onclick="location.reload()" class="btn">Retry</button></div>';
                    }
                });
            }
            
            // Refresh button functionality
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    if (iframe) {
                        iframe.src = iframe.src;
                        if (loadingDiv) {
                            loadingDiv.style.display = 'flex';
                        }
                    }
                });
            }
            
            // Monitor Streamlit communication
            window.addEventListener('message', function(event) {
                // Handle messages from Streamlit app
                const ORIGIN = window.STREAMLIT_ORIGIN || 'http://localhost:8501';
                const expectedOrigin = (ORIGIN.startsWith('/')) ? window.location.origin : ORIGIN;
                if (event.origin === expectedOrigin && event.data) {
                    handleStreamlitMessage(event.data);
                }
            });
        }
        
        function handleStreamlitMessage(data) {
            // Handle different message types from Streamlit
            if (data.type === 'tryon_complete') {
                showToast('Try-on completed successfully!', 'success');
                trackEvent('ai_tryon_complete', {
                    product: data.product,
                    success: true
                });
            } else if (data.type === 'tryon_error') {
                showToast('Try-on failed. Please try again.', 'error');
                trackEvent('ai_tryon_error', {
                    error: data.error
                });
            } else if (data.type === 'product_selected') {
                // Update URL with selected product for sharing
                const url = new URL(window.location);
                url.searchParams.set('product', data.product);
                window.history.replaceState({}, '', url);
            }
        }
        
        function applyProductPreselection() {
            const urlParams = new URLSearchParams(window.location.search);
            const productName = urlParams.get('product');
            const productId = urlParams.get('product_id');
            const sku = urlParams.get('sku');
            
            if (productName || productId || sku) {
                // Send product preselection to Streamlit iframe
                const iframe = document.getElementById('ai-tryon-frame');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'preselect_product',
                        product: productName,
                        product_id: productId,
                        sku: sku
                    }, ((window.STREAMLIT_ORIGIN || 'http://localhost:8501').startsWith('/') ? window.location.origin : (window.STREAMLIT_ORIGIN || 'http://localhost:8501')));
                }
                
                // Also update the local product selection if available
                updateLocalProductSelection(productName);
            }
        }
        
        function updateLocalProductSelection(productName) {
            if (!productName) return;
            
            // Find and select the product in the local interface
            const productOptions = document.querySelectorAll('.product-option');
            productOptions.forEach(option => {
                const nameEl = option.querySelector('h4');
                if (nameEl && nameEl.textContent.toLowerCase().includes(productName.toLowerCase())) {
                    productOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedProduct = nameEl.textContent.trim();
                    updateTryOnButton();
                }
            });
        }
        
        // Global function to open try-on with product preselection
        window.openTryOnWithProduct = function(productName, productId, sku) {
            const url = new URL('/pages/tryon/index.html', window.location.origin);
            if (productName) url.searchParams.set('product', productName);
            if (productId) url.searchParams.set('product_id', productId);
            if (sku) url.searchParams.set('sku', sku);
            window.location.href = url.toString();
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            // Load standardized components first
            loadStandardizedComponents();
            
            // Streamlit integration and product preselection
            (function(){
              const iframe = document.getElementById('ai-tryon-frame');
              const STREAMLIT_ORIGIN = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:8501' : '/ai';
              if (iframe) iframe.src = STREAMLIT_ORIGIN + '/';
              window.STREAMLIT_ORIGIN = STREAMLIT_ORIGIN;
              const openBtn = document.getElementById('openStreamlitTab');
              if (openBtn) openBtn.setAttribute('href', (STREAMLIT_ORIGIN + '/'));
            })();
            initializeStreamlitIntegration();
            
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('image-upload');
            const cameraBtn = document.getElementById('camera-btn');
            const previewContainer = document.getElementById('preview-container');
            const productOverlay = document.getElementById('product-overlay');
            const tryOnBtn = document.getElementById('try-on-btn');
            const downloadBtn = document.getElementById('download-btn');
            const shareBtn = document.getElementById('share-btn');
            
            let currentImage = null;
            let selectedProduct = null;
            let selectedSize = null;
            let selectedColor = null;
            
            // Handle file upload
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    handleImageUpload(e.target.files[0]);
                });
            }
            
            // Enhanced drag and drop
            if (uploadArea) {
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.style.borderColor = 'var(--primary)';
                    uploadArea.style.backgroundColor = 'rgba(58, 90, 64, 0.1)';
                });
                
                uploadArea.addEventListener('dragleave', function() {
                    uploadArea.style.borderColor = '#ddd';
                    uploadArea.style.backgroundColor = 'transparent';
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#ddd';
                    uploadArea.style.backgroundColor = 'transparent';
                    
                    if (e.dataTransfer.files.length) {
                        handleImageUpload(e.dataTransfer.files[0]);
                    }
                });
                
                uploadArea.addEventListener('click', function() {
                    fileInput.click();
                });
            }
            
            // Enhanced camera functionality
            if (cameraBtn) {
                cameraBtn.addEventListener('click', function() {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        alert('Camera access is not supported by your browser. Please use the file upload option.');
                        return;
                    }
                    
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(stream => {
                            // Create video element
                            const video = document.createElement('video');
                            video.srcObject = stream;
                            video.autoplay = true;
                            video.style.width = '100%';
                            video.style.height = '100%';
                            video.style.objectFit = 'cover';
                            
                            // Replace upload area with video
                            uploadArea.innerHTML = '';
                            uploadArea.appendChild(video);
                            
                            // Add capture button
                            const captureBtn = document.createElement('button');
                            captureBtn.textContent = 'Capture Photo';
                            captureBtn.className = 'btn';
                            captureBtn.style.position = 'absolute';
                            captureBtn.style.bottom = '20px';
                            captureBtn.style.left = '50%';
                            captureBtn.style.transform = 'translateX(-50%)';
                            
                            captureBtn.addEventListener('click', function() {
                                // Capture photo
                                const canvas = document.createElement('canvas');
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(video, 0, 0);
                                
                                // Stop camera
                                stream.getTracks().forEach(track => track.stop());
                                
                                // Convert to blob and handle
                                canvas.toBlob(function(blob) {
                                    handleImageUpload(blob);
                                });
                            });
                            
                            uploadArea.appendChild(captureBtn);
                        })
                        .catch(error => {
                            console.error('Error accessing camera:', error);
                            alert('Could not access camera: ' + error.message);
                        });
                });
            }
            
            // Product selection with enhanced functionality
            const productOptions = document.querySelectorAll('.product-option');
            productOptions.forEach(option => {
                option.addEventListener('click', function() {
                    productOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedProduct = this.dataset.product;
                    updateTryOnButton();
                    
                    // Send product selection to Streamlit
                    const iframe = document.getElementById('ai-tryon-frame');
                    if (iframe && iframe.contentWindow) {
                        const nameEl = this.querySelector('h4');
                        const productName = nameEl ? nameEl.textContent.trim() : '';
                        iframe.contentWindow.postMessage({
                            type: 'select_product',
                            product: productName
                        }, ((window.STREAMLIT_ORIGIN || 'http://localhost:8501').startsWith('/') ? window.location.origin : (window.STREAMLIT_ORIGIN || 'http://localhost:8501')));
                    }
                });
            });

            // Handle product preselection from URL parameters
            const params = new URLSearchParams(window.location.search);
            const preselectProduct = params.get('product');
            if (preselectProduct) {
                setTimeout(() => {
                    updateLocalProductSelection(preselectProduct);
                }, 500);
            }
            
            // Size selection
            const sizeOptions = document.querySelectorAll('.size-option');
            sizeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    sizeOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSize = this.dataset.size;
                    updateTryOnButton();
                });
            });
            
            // Color selection
            const colorOptions = document.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedColor = this.dataset.color;
                    updateTryOnButton();
                });
            });
            
            // Try-on button functionality
            if (tryOnBtn) {
                tryOnBtn.addEventListener('click', function() {
                    if (!currentImage) {
                        alert('Please upload an image first.');
                        return;
                    }
                    
                    if (!selectedProduct) {
                        alert('Please select a product to try on.');
                        return;
                    }
                    
                    performTryOn();
                });
            }
            
            // Download functionality
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function() {
                    if (productOverlay && productOverlay.style.display !== 'none') {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const img = previewContainer.querySelector('img');
                        
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        
                        ctx.drawImage(img, 0, 0);
                        
                        // Add product overlay to canvas
                        const overlayImg = productOverlay.querySelector('img');
                        if (overlayImg) {
                            ctx.drawImage(overlayImg, 0, 0);
                        }
                        
                        // Download
                        const link = document.createElement('a');
                        link.download = 'try-on-result.png';
                        link.href = canvas.toDataURL();
                        link.click();
                    }
                });
            }
            
            // Share functionality
            if (shareBtn) {
                shareBtn.addEventListener('click', function() {
                    if (navigator.share) {
                        navigator.share({
                            title: 'Check out my Reweave try-on!',
                            text: 'I just tried on this amazing sustainable fashion piece!',
                            url: window.location.href
                        });
                    } else {
                        // Fallback to copying URL
                        navigator.clipboard.writeText(window.location.href).then(() => {
                            alert('Link copied to clipboard!');
                        });
                    }
                });
            }
            
            // Enhanced image upload handler
            function handleImageUpload(file) {
                if (!file) return;
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please upload an image file.');
                    return;
                }
                
                // Validate file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('Image file is too large. Please choose a file smaller than 10MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentImage = event.target.result;
                    
                    // Display the uploaded image
                    previewContainer.innerHTML = `
                        <img src="${event.target.result}" alt="User uploaded image" style="width: 100%; height: 100%; object-fit: contain;">
                        <div class="image-overlay">
                            <div class="upload-success">
                                <i class="fas fa-check-circle"></i>
                                <p>Image uploaded successfully!</p>
                            </div>
                        </div>
                    `;
                    
                    // Reset product overlay
                    if (productOverlay) {
                        productOverlay.style.display = 'none';
                        productOverlay.innerHTML = '';
                    }
                    
                    updateTryOnButton();
                };
                reader.readAsDataURL(file);
            }
            
            // Update try-on button state
            function updateTryOnButton() {
                if (tryOnBtn) {
                    if (currentImage && selectedProduct) {
                        tryOnBtn.disabled = false;
                        tryOnBtn.textContent = 'Try On Now';
                    } else {
                        tryOnBtn.disabled = true;
                        tryOnBtn.textContent = 'Upload Image & Select Product';
                    }
                }
            }
            
            // Perform try-on simulation
            function performTryOn() {
                if (!currentImage || !selectedProduct) return;
                
                // Show loading state
                if (productOverlay) {
                    productOverlay.style.display = 'block';
                    productOverlay.innerHTML = `
                        <div class="loading-overlay">
                            <div class="spinner"></div>
                            <p>Processing your try-on...</p>
                        </div>
                    `;
                }
                
                // Simulate AI processing
                setTimeout(() => {
                    if (productOverlay) {
                        productOverlay.innerHTML = `
                            <div class="try-on-result">
                                <img src="https://images.unsplash.com/photo-1566150905458-1bf1fc113f0d?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=80" alt="Try-on result" style="width: 100%; height: 100%; object-fit: cover;">
                                <div class="result-overlay">
                                    <div class="result-info">
                                        <h3>Try-On Complete!</h3>
                                        <p>Product: ${selectedProduct}</p>
                                        ${selectedSize ? `<p>Size: ${selectedSize}</p>` : ''}
                                        ${selectedColor ? `<p>Color: ${selectedColor}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Enable action buttons
                    if (downloadBtn) downloadBtn.style.display = 'inline-block';
                    if (shareBtn) shareBtn.style.display = 'inline-block';
                }, 2000);
            }

            // Wardrobe Mirror logic
            const API_PRODUCTS = '/api/products.json';
            const API_SUGGEST = (window.REWEAVE_API_BASE ? (window.REWEAVE_API_BASE + '/suggest') : null);
            const mirrorInput = document.getElementById('mirrorInput');
            const mirrorPreview = document.getElementById('mirrorPreview');
            const mirrorSuggestBtn = document.getElementById('mirrorSuggest');
            const mirrorSuggestions = document.getElementById('mirrorSuggestions');
            let wardrobeImages = [];

            if (mirrorInput) {
                mirrorInput.addEventListener('change', function(e){
                    wardrobeImages = Array.from(e.target.files || []);
                    mirrorPreview.innerHTML = '';
                    wardrobeImages.slice(0,6).forEach(file => {
                        const url = URL.createObjectURL(file);
                        const img = document.createElement('img');
                        img.src = url; img.style.width='72px'; img.style.height='72px'; img.style.borderRadius='8px'; img.style.objectFit='cover';
                        mirrorPreview.appendChild(img);
                    });
                });
            }

            function dominantColorNameFromImage(file) {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = function(){
                        const canvas = document.createElement('canvas');
                        const w = 64, h = 64; canvas.width=w; canvas.height=h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        const data = ctx.getImageData(0,0,w,h).data;
                        let r=0,g=0,b=0,count=0;
                        for (let i=0;i<data.length;i+=4){ r+=data[i]; g+=data[i+1]; b+=data[i+2]; count++; }
                        r=Math.round(r/count); g=Math.round(g/count); b=Math.round(b/count);
                        // Map to simple names
                        const max = Math.max(r,g,b), min = Math.min(r,g,b);
                        const brightness = (r+g+b)/3;
                        let name='neutral';
                        if (brightness < 60) name='black';
                        else if (r>g && r>b) name='red';
                        else if (g>r && g>b) name='gold';
                        else if (b>r && b>g) name='blue';
                        else name='natural';
                        resolve(name);
                    };
                    img.onerror = function(){ resolve('neutral'); };
                    img.src = URL.createObjectURL(file);
                });
            }

            function minPriceFromProduct(p){
                const minVariant = (p.variants || [])[0] || { price: p.price || 0 };
                return (p.variants || []).reduce((m,v)=>Math.min(m, Number(v.price||0)), Number(minVariant.price||0));
            }

            if (mirrorSuggestBtn) {
                mirrorSuggestBtn.addEventListener('click', async function(){
                    mirrorSuggestions.innerHTML = '<p style="color:#777">Analyzing wardrobe and fetching matches...</p>';
                    const colors = [];
                    for (const f of wardrobeImages.slice(0,3)) { try { colors.push(await dominantColorNameFromImage(f)); } catch {} }
                    fetch(API_PRODUCTS).then(r=>r.json()).then(async data => {
                        const list = Array.isArray(data) ? data : (data.products || []);
                        let picks;
                        if (API_SUGGEST) {
                            try {
                                const res = await fetch(API_SUGGEST, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ mode:'mirror', colors, products:list }) });
                                const js = await res.json();
                                picks = (js.suggestions||[]);
                            } catch { picks = []; }
                        }
                        if (!picks || !picks.length) {
                            const scored = list.map(p => {
                                const variantColors = (p.variants||[]).map(v => (v.options && (v.options.Color||v.options.color)) || '').map(s=>String(s).toLowerCase());
                                let score = 0;
                                colors.forEach(c => { if (variantColors.includes(c)) score += 2; });
                                if ((p.categories||[]).includes('Bags')) score += 1;
                                return { p, score };
                            }).sort((a,b)=>b.score - a.score).slice(0,6).map(x=>x.p);
                            picks = scored.map(p => ({ product:p, justification: generateJustification(p, { context:'mirror', colors }) }));
                        } else {
                            picks = picks.map(s => ({ product: s.product || s, justification: s.justification || generateJustification(s.product||s, { context:'mirror', colors }) }));
                        }
                        renderSuggestionGridWithVoice(picks, mirrorSuggestions);
                    }).catch(()=>{
                        mirrorSuggestions.innerHTML = '<p style="color:#c00">Could not load products. Try again.</p>';
                    });
                });
            }

            const copilotOccasion = document.getElementById('copilotOccasion');
            const copilotPalette = document.getElementById('copilotPalette');
            const copilotBudget = document.getElementById('copilotBudget');
            const copilotBtn = document.getElementById('copilotRecommend');
            const copilotSuggestions = document.getElementById('copilotSuggestions');

            if (copilotBtn) {
                copilotBtn.addEventListener('click', function(){
                    const occ = (copilotOccasion?.value)||'work';
                    const pal = (copilotPalette?.value)||'neutral';
                    const budget = Number((copilotBudget?.value)||0) || 1000;
                    copilotSuggestions.innerHTML = '<p style="color:#777">Finding outfits...</p>';
                    fetch(API_PRODUCTS).then(r=>r.json()).then(async data => {
                        const list = Array.isArray(data) ? data : (data.products || []);
                        let picks;
                        if (API_SUGGEST) {
                            try {
                                const res = await fetch(API_SUGGEST, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ mode:'copilot', occasion:occ, palette:pal, budget, products:list }) });
                                const js = await res.json();
                                picks = (js.suggestions||[]);
                            } catch { picks = []; }
                        }
                        if (!picks || !picks.length) {
                            let filtered = list;
                            if (occ === 'work') filtered = list.filter(p => (p.categories||[]).includes('Tote') || (p.categories||[]).includes('Sling'));
                            if (occ === 'casual') filtered = list.filter(p => (p.categories||[]).includes('Pouch') || (p.categories||[]).includes('Sling'));
                            if (occ === 'evening') filtered = list.filter(p => (p.categories||[]).includes('Sling'));
                            filtered = filtered.filter(p => minPriceFromProduct(p) <= budget);
                            const paletteColors = pal==='warm' ? ['gold','red','natural'] : pal==='cool' ? ['blue','black'] : ['natural','black'];
                            filtered = filtered.sort((a,b)=>{
                                const av = (a.variants||[]).map(v=>String((v.options&& (v.options.Color||v.options.color))||'').toLowerCase());
                                const bv = (b.variants||[]).map(v=>String((v.options&& (v.options.Color||v.options.color))||'').toLowerCase());
                                const ascore = av.some(c=>paletteColors.includes(c)) ? 1 : 0;
                                const bscore = bv.some(c=>paletteColors.includes(c)) ? 1 : 0;
                                return bscore - ascore;
                            }).slice(0,6);
                            picks = filtered.map(p => ({ product:p, justification: generateJustification(p, { context:'copilot', occasion:occ, palette:pal, budget }) }));
                        } else {
                            picks = picks.map(s => ({ product: s.product || s, justification: s.justification || generateJustification(s.product||s, { context:'copilot', occasion:occ, palette:pal, budget }) }));
                        }
                        renderSuggestionGridWithVoice(picks, copilotSuggestions);
                    }).catch(()=>{ copilotSuggestions.innerHTML = '<p style="color:#c00">Could not load products.</p>'; });
                });
            }

            function generateJustification(p, ctx){
                const price = Number(minPriceFromProduct(p));
                const colors = (p.variants||[]).map(v=>String((v.options&& (v.options.Color||v.options.color))||'').toLowerCase());
                const name = p.name || 'This piece';
                const occ = ctx.occasion || 'everyday';
                const pal = ctx.palette || 'neutral';
                const matchColor = (ctx.colors||[]).find(c=>colors.includes(c));
                const tone = [
                  `${name} commands attention with refined lines and artisanal detail`,
                  `A polished silhouette that elevates ${occ} moments effortlessly`,
                  `Meticulously crafted to deliver enduring presence and utility`
                ];
                const colorLine = matchColor ? `The ${matchColor} variant harmonizes with your palette for cohesive styling` : `The palette reads ${pal}, pairing with your wardrobe in confident balance`;
                const valueLine = ctx.budget ? `Priced at RM ${price.toFixed(2)}, it respects your budget while maintaining luxury codes` : `Priced at RM ${price.toFixed(2)}, it balances craftsmanship and daily ease`;
                return `${tone[0]}. ${tone[1]}. ${colorLine}. ${valueLine}.`;
            }

            function renderSuggestionGridWithVoice(items, target){
                target.innerHTML = items.map(x => {
                    const p = x.product || x;
                    const price = minPriceFromProduct(p);
                    const img = (p.images && p.images[0]) || 'https://via.placeholder.com/300x300?text=Reweave';
                    const j = x.justification || '';
                    return `
                      <div class="feature-card">
                        <div class="feature-thumb"><img src="${img}" alt="${p.name}" /></div>
                        <div class="feature-info">
                          <div class="name">${p.name}</div>
                          <div class="price">RM ${Number(price).toFixed(2)}</div>
                          <div class="sales-voice">${j}</div>
                        </div>
                        <div class="feature-actions">
                          <button class="btn btn-secondary" data-action="add" data-id="${p.id}" data-name="${p.name}" data-price="${Number(price)}" data-image="${img}">Add</button>
                          <button class="btn" data-action="buy" data-id="${p.id}" data-name="${p.name}" data-price="${Number(price)}" data-image="${img}">Buy Now</button>
                          <button class="btn btn-outline" data-action="try" data-name="${p.name}">Try On</button>
                        </div>
                      </div>`;
                }).join('');
                Array.from(target.querySelectorAll('button')).forEach(btn => {
                    btn.addEventListener('click', function(){
                        const act = this.getAttribute('data-action');
                        if (act === 'add') {
                            window.AIShop?.addToCart({ id: this.getAttribute('data-id'), name: this.getAttribute('data-name'), price: Number(this.getAttribute('data-price')||0), qty:1, image:this.getAttribute('data-image')||'' });
                        } else if (act === 'buy') {
                            window.AIShop?.buyNow({ id: this.getAttribute('data-id'), name: this.getAttribute('data-name'), price: Number(this.getAttribute('data-price')||0), qty:1, image:this.getAttribute('data-image')||'' });
                        } else if (act === 'try') {
                            window.AIShop?.openTryOn(this.getAttribute('data-name'));
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>