<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reweave • Sustainable Fashion, Reimagined</title>
  <link rel="icon" type="image/png" href="images/Reweave_logo-removebg-preview.png" />
  <link rel="stylesheet" href="/shared/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- SEO and Structured Data -->
  <meta name="description" content="Crafted essentials for modern life. Curated silhouettes in heritage Songket and Batik. Handwoven craft meets daily utility." />
  <meta name="keywords" content="sustainable fashion, batik, songket, handcrafted, malaysian fashion, eco-friendly clothing" />
  <meta property="og:title" content="Reweave • Sustainable Fashion, Reimagined" />
  <meta property="og:description" content="Crafted essentials for modern life. Curated silhouettes in heritage Songket and Batik." />
  <meta property="og:image" content="images/Batik Front (WIP).png" />
  <meta property="og:url" content="https://www.reweave.shop" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  
  <!-- Organization Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Reweave",
    "url": "https://www.reweave.shop",
    "logo": "https://www.reweave.shop/images/Reweave_logo-removebg-preview.png",
    "description": "Sustainable fashion reimagined - crafted essentials in heritage Songket and Batik",
    "sameAs": [
      "https://www.instagram.com/reweave.my",
      "https://www.facebook.com/reweave.my"
    ],
    "contactPoint": {
      "@type": "ContactPoint",
      "telephone": "+60-12-345-6789",
      "contactType": "customer service",
      "areaServed": "MY",
      "availableLanguage": ["en", "ms"]
    }
  }
  </script>
  
  <!-- Website Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Reweave",
    "url": "https://www.reweave.shop",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://www.reweave.shop/search?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>
  
  <style>
    /* Page-specific styles */
    .hero {
      padding: 140px 0 80px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--luxury-gray) 0%, var(--primary-white) 100%);
    }
    
    .hero-content {
      max-width: var(--container-max-width);
      margin: 0 auto;
      padding: 0 var(--container-padding);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 60px;
      align-items: center;
    }
    
    .hero-text h1 {
      font-family: var(--font-serif);
      font-size: 3.5rem;
      font-weight: 300;
      line-height: 1.2;
      margin-bottom: 20px;
      letter-spacing: -1px;
    }
    
    .hero-text p {
      font-size: 1.2rem;
      color: var(--text-gray);
      margin-bottom: 30px;
      font-weight: 300;
    }
    
    .hero-actions {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .hero-image img {
      width: 100%;
      height: auto;
      border-radius: var(--border-radius-large);
      box-shadow: var(--shadow-heavy);
    }

    .products {
      padding: 80px 0;
      background: var(--primary-white);
    }
    
    .section-title {
      font-family: var(--font-serif);
      font-size: 2.5rem;
      font-weight: 300;
      text-align: center;
      margin-bottom: 50px;
      letter-spacing: 1px;
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 40px;
      margin-top: 40px;
    }
    
    .product-card {
      background: var(--primary-white);
      border-radius: var(--border-radius-large);
      overflow: hidden;
      transition: var(--transition);
      border: 1px solid var(--border-gray);
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-medium);
    }
    
    .product-image {
      width: 100%;
      height: 300px;
      object-fit: cover;
      transition: var(--transition);
    }
    
    .product-card:hover .product-image {
      transform: scale(1.05);
    }
    
    .product-info {
      padding: 24px;
    }
    
    .product-title {
      font-family: var(--font-serif);
      font-size: 1.4rem;
      font-weight: 300;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    
    .product-price {
      font-size: 1.1rem;
      color: var(--text-gray);
      margin-bottom: 16px;
      font-weight: 300;
    }
    
    .product-options {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .option-btn {
      padding: 6px 12px;
      border: 1px solid var(--border-gray);
      background: var(--primary-white);
      border-radius: var(--border-radius);
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition);
      font-family: var(--font-sans);
      font-weight: 300;
    }
    
    .option-btn:hover,
    .option-btn.active {
      background: var(--primary-black);
      color: var(--primary-white);
      border-color: var(--primary-black);
    }
    
    .product-actions {
      display: flex;
      gap: 12px;
    }
    
    .product-actions .btn {
      flex: 1;
      padding: 10px 16px;
      font-size: 13px;
    }
    
    .trust {
      padding: 60px 0;
      background: var(--luxury-gray);
    }
    
    .trust-badges {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .hero-content {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 40px;
      }
      
      .hero-text h1 {
        font-size: 2.5rem;
      }
      
      .hero-actions {
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .products-grid {
        grid-template-columns: 1fr;
        gap: 30px;
      }
      
      .trust-badges {
        gap: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .hero-text h1 {
        font-size: 2rem;
      }
      
      .section-title {
        font-size: 2rem;
      }
      
      .hero-actions {
        flex-direction: column;
        align-items: center;
      }
      
      .hero-actions .btn {
        width: 100%;
        max-width: 250px;
      }
    }
  </style>
</head>
<body>
  <!-- Standardized Header -->
  <!-- Standardized Header Component for Reweave -->
  <header class="header">
    <div class="header-container">
      <div class="nav-left">
      <button class="nav-btn" title="AI Try-On">AI Try-On</button>
      </div>
      
      <a href="/" class="logo">REWEAVE</a>
      
      <div class="nav-right">
      <button class="nav-btn cart-btn">
          <i class="fas fa-shopping-bag"></i>
          <span class="cart-count" id="cartCount">0</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-content">
      <div class="hero-text">
        <h1>Crafted essentials for modern life</h1>
        <p>Curated silhouettes in heritage Songket and Batik. Handwoven craft meets daily utility.</p>
        <div class="hero-actions">
          <a href="#products" class="btn">Shop Now</a>
          <a href="/tryon" class="btn btn-outline">AI Try-On</a>
          <a href="/pages/story/index.html" class="btn btn-outline">Our Story</a>
        </div>
        <div class="trust-badges">
          <span class="trust-badge">FPX Available</span>
          <span class="trust-badge">Visa</span>
          <span class="trust-badge">Mastercard</span>
          <span class="trust-badge">30-day Returns</span>
        </div>
      </div>
      <div class="hero-image">
        <img src="images/Batik Front (WIP).png" alt="Reweave Heritage Collection" loading="lazy" />
      </div>
    </div>
  </section>

  <!-- Products Section -->
  <section class="products" id="products">
    <div class="container">
      <h2 class="section-title">Shop the Collection</h2>
      
      <div class="products-grid" id="productsGrid">
        <!-- Products will be loaded dynamically from Supabase -->
        <div class="text-center" style="grid-column: 1 / -1; padding: 60px 0;">
          <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--text-gray); margin-bottom: 20px;"></i>
          <p style="color: var(--text-gray);">Loading products...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Trust Section -->
  <section class="trust">
    <div class="container">
      <div class="trust-badges">
        <span class="trust-badge">Free Shipping Above RM150</span>
        <span class="trust-badge">30-Day Returns</span>
        <span class="trust-badge">Handcrafted Quality</span>
        <span class="trust-badge">Sustainable Materials</span>
      </div>
    </div>
  </section>

  <!-- Standardized Footer -->
  <!-- Standardized Footer Component for Reweave -->
  <footer class="footer">
    <div class="container">
      <div class="footer-brand">REWEAVE</div>
      <div class="footer-text">
      Sustainable fashion, reimagined. Crafting heritage into modern essentials.
    </div>
    <div class="footer-trust">
      <span class="trust-badge">FPX Available</span>
      <span class="trust-badge">Visa</span>
      <span class="trust-badge">Mastercard</span>
      <span class="trust-badge">30-day Returns</span>
      </div>
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/shared/script.js"></script>
  <script>
    // Supabase configuration
    const supabaseUrl = 'https://dkpaeiyixdwzjpvvszyy.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrcGFlaXlpeGR3empwdnZzenl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MjAyNTUsImV4cCI6MjA3OTA5NjI1NX0.tcESQl8N7gFFkzh-OOvRBnHFyJ2CC9W0-vs3e6ItZTc';
    
    let supabaseClient;
    
    // Wait for Supabase library to load
    function initSupabase() {
      if (typeof supabase !== 'undefined') {
        try {
          supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
          console.log('Supabase client initialized successfully');
          return true;
        } catch (err) {
          console.error('Failed to create Supabase client:', err);
          return false;
        }
      } else {
        console.error('Supabase library not loaded yet');
        return false;
      }
    }
    
    // Initialize immediately if available, otherwise wait
    if (!initSupabase()) {
      // Wait a bit for the library to load
      setTimeout(() => {
        if (!initSupabase()) {
          console.error('Supabase library failed to load after timeout');
        }
      }, 1000);
    }

    // Test Supabase connection
    async function testSupabaseConnection() {
      try {
        const { data, error } = await supabaseClient
          .from('product_variants')
          .select('id, price')
          .limit(1);
        
        if (error) {
          console.error('Supabase connection test failed:', error);
          return false;
        }
        
        console.log('Supabase connection successful. Sample data:', data);
        return true;
      } catch (error) {
        console.error('Supabase connection test error:', error);
        return false;
      }
    }

    // Products functionality
    let products = [];
    
    // Fetch product variants from Supabase
    async function fetchProducts() {
      const productsGrid = document.getElementById('productsGrid');
      
      // Check if Supabase client is available
      if (!supabaseClient) {
        console.error('Supabase client not initialized');
        showFallbackProducts();
        return;
      }
      
      try {
        console.log('Fetching products from Supabase...');
        console.log('Supabase URL:', supabaseUrl);
        
        const { data, error } = await supabaseClient
          .from('product_variants')
          .select('id, product_id, variant_name, price, color, image, is_active, products(title, description, category)')
          .eq('is_active', true)
          .order('product_id');
        
        console.log('Supabase response:', { 
          hasData: !!data, 
          dataLength: data?.length, 
          error: error?.message || null 
        });
        
        if (error) {
          console.error('Error fetching product variants:', error);
          console.error('Error details:', JSON.stringify(error, null, 2));
          showFallbackProducts();
          return;
        }
        
        if (!data || data.length === 0) {
          console.warn('No products found in Supabase');
          showFallbackProducts();
          return;
        }
        
        console.log(`Successfully fetched ${data.length} variants from Supabase`);
        
        // Helper function to clean and normalize price
        function cleanPrice(price) {
          if (price === null || price === undefined) return 0;
          if (typeof price === 'string') {
            // Remove "RM " prefix and any whitespace, then parse
            const cleaned = parseFloat(price.replace(/RM\s*/gi, '').trim());
            return isNaN(cleaned) ? 0 : cleaned;
          }
          const numPrice = parseFloat(price);
          return isNaN(numPrice) ? 0 : numPrice;
        }
        
        // Group variants by product
        const groupedProducts = {};
        data.forEach(variant => {
          try {
            // Clean and normalize price - ensure it's always a valid number
            const originalPrice = variant.price;
            variant.price = cleanPrice(variant.price);
            
            // Validate price exists
            if (variant.price === 0 || isNaN(variant.price)) {
              console.error(`Variant ${variant.id} (${variant.variant_name}) has invalid price:`, originalPrice, '-> cleaned:', variant.price);
              // Skip variants without valid prices
              return;
            }
            
            // Debug: Log first variant to check structure
            if (data.indexOf(variant) === 0) {
              console.log('Sample variant from database:', variant);
              console.log('Price field - original:', originalPrice, 'cleaned:', variant.price, 'Type:', typeof variant.price);
            }
            
          if (!groupedProducts[variant.product_id]) {
            groupedProducts[variant.product_id] = {
              id: variant.product_id,
                title: variant.products?.title || 'Product',
                description: variant.products?.description || '',
                category: variant.products?.category || '',
              variants: []
            };
          }
          groupedProducts[variant.product_id].variants.push(variant);
          } catch (err) {
            console.error('Error processing variant:', variant, err);
          }
        });
        
        products = Object.values(groupedProducts);
        console.log(`Grouped into ${products.length} products`);
        
        if (products.length === 0) {
          console.warn('No products after grouping. Showing fallback.');
          showFallbackProducts();
          return;
        }
        
        renderProducts(products);
        
        // Track product view
        trackEvent('view_product_list', {
          category: 'homepage',
          product_count: products.length
        });
        
      } catch (error) {
        console.error('Error fetching product variants:', error);
        console.error('Error stack:', error.stack);
        console.error('Error message:', error.message);
        
        // Show user-friendly error message
        const productsGrid = document.getElementById('productsGrid');
        if (productsGrid) {
          productsGrid.innerHTML = `
            <div class="text-center" style="grid-column: 1 / -1; padding: 40px 0;">
              <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--text-gray); margin-bottom: 20px;"></i>
              <p style="color: var(--text-gray); margin-bottom: 10px;">Unable to load products.</p>
              <p style="color: var(--text-gray); font-size: 0.9rem; margin-bottom: 30px;">${error.message || 'Please check your connection and try again.'}</p>
              <button onclick="location.reload()" class="btn" style="margin-right: 10px;">Retry</button>
              <a href="pages/shop/index.html" class="btn btn-outline">Browse Shop</a>
            </div>
          `;
        }
      }
    }
    
    function showFallbackProducts() {
      // Show fallback products if Supabase is unavailable
      const productsGrid = document.getElementById('productsGrid');
      productsGrid.innerHTML = `
        <div class="text-center" style="grid-column: 1 / -1; padding: 40px 0;">
          <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--text-gray); margin-bottom: 20px;"></i>
          <p style="color: var(--text-gray); margin-bottom: 30px;">Unable to load products from our database.</p>
          <a href="pages/shop/index.html" class="btn">Browse Shop</a>
        </div>
      `;
    }
    
    // Render products with variants
    function renderProducts(productsData) {
      const productsGrid = document.getElementById('productsGrid');
      productsGrid.innerHTML = '';
      
      if (productsData.length === 0) {
        productsGrid.innerHTML = `
          <div class="text-center" style="grid-column: 1 / -1; padding: 60px 0;">
            <i class="fas fa-shopping-bag" style="font-size: 3rem; color: var(--text-gray); margin-bottom: 20px;"></i>
            <h3 style="margin-bottom: 10px;">No products available</h3>
            <p style="color: var(--text-gray);">Check back soon for new arrivals!</p>
          </div>
        `;
        return;
      }
      
      productsData.forEach(product => {
        if (product.variants.length === 0) return;
        
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.dataset.productId = product.id;
        
        // Use first variant as default display
        const defaultVariant = product.variants[0];
        
        // Ensure price is a valid number (should already be cleaned, but double-check)
        const cleanPrice = (price) => {
          if (price === null || price === undefined) return 0;
          if (typeof price === 'string') {
            const cleaned = parseFloat(price.replace(/RM\s*/gi, '').trim());
            return isNaN(cleaned) ? 0 : cleaned;
          }
          const numPrice = parseFloat(price);
          return isNaN(numPrice) ? 0 : numPrice;
        };
        
        const variantPrice = cleanPrice(defaultVariant.price);
        
        // Validate price exists
        if (variantPrice === 0 || isNaN(variantPrice)) {
          console.error(`Variant ${defaultVariant.id} (${defaultVariant.variant_name}) has invalid price:`, defaultVariant.price, '-> cleaned:', variantPrice);
          console.error('Full variant data:', defaultVariant);
          // Skip products without valid prices
          return;
        }
        
        // Update variant price to ensure it's a number
        defaultVariant.price = variantPrice;
        
        // Debug: Log variant data to check prices (only for first product)
        if (productsData.indexOf(product) === 0) {
          console.log('Sample product variant data:', {
            productId: product.id,
            variantId: defaultVariant.id,
            variantName: defaultVariant.variant_name,
            price: defaultVariant.price,
            priceType: typeof defaultVariant.price,
            allFields: Object.keys(defaultVariant)
          });
        }
        
        // Create color options from variants
        const colorOptions = product.variants.map((variant, index) => 
          `<button class="option-btn ${index === 0 ? 'active' : ''}" 
                   onclick="selectVariant('${product.id}', '${variant.id}', this)"
                   data-variant-id="${variant.id}"
                   aria-label="Select ${variant.color} variant">
            ${variant.color}
          </button>`
        ).join('');
        
        productCard.innerHTML = `
          <img src="${defaultVariant.image}" 
               alt="${defaultVariant.variant_name}" 
               class="product-image" 
               id="image-${product.id}"
               loading="lazy">
          <div class="product-info">
            <h3 class="product-title" id="title-${product.id}">${defaultVariant.variant_name}</h3>
            <div class="product-price" id="price-${product.id}">RM ${defaultVariant.price.toFixed(2)}</div>
            <div class="product-options" id="options-${product.id}" role="group" aria-label="Color options">
              ${colorOptions}
            </div>
            <div class="product-actions">
              <button class="btn" 
                      data-add-to-cart
                      id="cart-${product.id}"
                      data-product-id="${defaultVariant.id}"
                      data-product-name="${defaultVariant.variant_name}"
                      data-product-price="${defaultVariant.price}"
                      data-product-image="${defaultVariant.image || ''}"
                      data-variant="${defaultVariant.color || 'default'}">
                Add to Cart
              </button>
              <button class="btn btn-outline"
                      onclick="window.location.href = '/tryon'"
                      title="Try It On">
                Try It On
              </button>
              <button class="btn btn-outline"
                      data-buy-now
                      data-product-id="${defaultVariant.id}"
                      data-product-name="${defaultVariant.variant_name}"
                      data-product-price="${defaultVariant.price}"
                      data-product-image="${defaultVariant.image || ''}"
                      data-variant="${defaultVariant.color || 'default'}">
                Buy Now
              </button>
            </div>
          </div>
        `;
        
        productsGrid.appendChild(productCard);
      });
    }
    
    // Handle variant selection
    function selectVariant(productId, variantId, button) {
      // Update active state
      const productCard = button.closest('.product-card');
      productCard.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      
      // Find the variant data
      const product = products.find(p => p.id === productId);
      const variant = product.variants.find(v => v.id === variantId);
      
      if (variant) {
        // Clean and normalize price - ensure it's a number
        const cleanPrice = (price) => {
          if (price === null || price === undefined) return 0;
          if (typeof price === 'string') {
            const cleaned = parseFloat(price.replace(/RM\s*/gi, '').trim());
            return isNaN(cleaned) ? 0 : cleaned;
          }
          const numPrice = parseFloat(price);
          return isNaN(numPrice) ? 0 : numPrice;
        };
        
        const variantPrice = cleanPrice(variant.price);
        
        // Validate variant has a price
        if (variantPrice === 0 || isNaN(variantPrice)) {
          console.error(`Cannot update cart button: Variant ${variant.id} has invalid price:`, variant.price, '-> cleaned:', variantPrice);
          return;
        }
        
        // Update display
        document.getElementById(`image-${productId}`).src = variant.image;
        document.getElementById(`title-${productId}`).textContent = variant.variant_name;
        document.getElementById(`price-${productId}`).textContent = `RM ${variantPrice.toFixed(2)}`;
        
        // Update cart button
        const cartBtn = document.getElementById(`cart-${productId}`);
        if (!cartBtn) {
          console.error(`Cart button not found for product ${productId}`);
          return;
        }
        
        // Remove any inline onclick handlers - use event listener instead
        cartBtn.removeAttribute('onclick');
        cartBtn.setAttribute('data-product-id', variant.id);
        cartBtn.setAttribute('data-product-name', variant.variant_name);
        // Store price as string (HTML attributes are always strings, but ensure it's a valid number)
        cartBtn.setAttribute('data-product-price', String(variantPrice));
        cartBtn.setAttribute('data-product-image', variant.image || '');
        cartBtn.setAttribute('data-variant', variant.color || 'default');
        // Ensure data-add-to-cart attribute is present
        if (!cartBtn.hasAttribute('data-add-to-cart')) {
            cartBtn.setAttribute('data-add-to-cart', '');
        }
        
        // Update buy now button (it's the third button after cart button)
        const buyNowBtn = cartBtn.parentElement.querySelector('[data-buy-now]');
        if (buyNowBtn) {
          buyNowBtn.setAttribute('data-product-id', variant.id);
          buyNowBtn.setAttribute('data-product-name', variant.variant_name);
          buyNowBtn.setAttribute('data-product-price', String(variantPrice));
          buyNowBtn.setAttribute('data-product-image', variant.image || '');
          buyNowBtn.setAttribute('data-variant', variant.color || 'default');
        }
        
        console.log('Updated cart button for variant:', {
          productId,
          variantId: variant.id,
          originalPrice: variant.price,
          cleanedPrice: variantPrice,
          storedPrice: cartBtn.getAttribute('data-product-price'),
          datasetPrice: cartBtn.dataset.productPrice
        });
        
        // Track variant selection
        trackEvent('select_variant', {
          product_id: productId,
          variant_id: variantId,
          variant_color: variant.color
        });
      }
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      // Ensure Supabase is initialized
      if (!supabaseClient) {
        if (!initSupabase()) {
          console.error('Cannot initialize Supabase. Showing fallback.');
          showFallbackProducts();
          return;
        }
      }
      
      // Try to fetch products
      fetchProducts();
      
      // Test connection in background (non-blocking)
      testSupabaseConnection().then(connected => {
        if (!connected) {
          console.warn('Supabase connection test failed, but products may still load');
        }
      }).catch(err => {
        console.warn('Connection test error (non-critical):', err);
      });
      
      // Add smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });
    
      // Close menu when clicking outside
      document.addEventListener('click', function(e) {
        const mobileMenu = document.getElementById('mobileMenu');
        const menuBtn = document.querySelector('.menu-btn');
        
        if (mobileMenu && mobileMenu.classList.contains('active')) {
          const clickedInsideMenu = mobileMenu.contains(e.target);
          const clickedMenuBtn = menuBtn && menuBtn.contains(e.target);
          
          if (!clickedInsideMenu && !clickedMenuBtn) {
            toggleMenu(false);
          }
        }
      });
      
      // Close menu on escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          toggleMenu(false);
        }
      });
      
      // Close menu when window is resized to desktop
      window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
          toggleMenu(false);
        }
      });
    });
    
    // Mobile menu toggle function
    function toggleMenu(forceClose) {
      const mobileMenu = document.getElementById('mobileMenu');
      const body = document.body;
      
      if (!mobileMenu) return;
      
      const shouldOpen = forceClose === false ? false : !mobileMenu.classList.contains('active');
      
      if (shouldOpen) {
        mobileMenu.classList.add('active');
        body.classList.add('nav-open');
        body.style.overflow = 'hidden';
      } else {
        mobileMenu.classList.remove('active');
        body.classList.remove('nav-open');
        body.style.overflow = '';
      }
    }
  </script>
  
  <!-- AI Chatbot Widget -->
  <script src="/shared/chatbot.js"></script>
</body>
</html>
